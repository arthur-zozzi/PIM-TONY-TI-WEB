@using System.Linq
@model IEnumerable<TonyTI_Web.Models.Chamado>

    @{
    // Layout e título da página
    Layout = "_Layout";
    ViewData["Title"] = "Chamados";

    // Flag enviada pelo controller que indica se o usuário é técnico
    var isTecnico = (ViewBag.IsTecnico as bool?) ?? false;
    }

    <div class="container">
        <h2>@(isTecnico ? "Todos os Chamados" : "Meus Chamados")</h2>

        @* Exibe mensagem de feedback (TempData) *@
        @if (TempData["Message"] != null)
    {
        <div class="alert alert-info">@TempData["Message"]</div>
    }

        <div class="mb-3">
            <a class="btn btn-primary" href="@Url.Action("Create","Chamados")">Abrir Chamado</a>

            @* Botão extra visível apenas para técnicos *@
            @if (isTecnico)
        {
            <a class="btn btn-outline-secondary" href="@Url.Action("Index","Chamados")" style="margin-left:8px;">Atualizar lista</a>
        }
        </div>

        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Código</th>
                    <th>Nome</th>
                    <th>Urgência</th>
                    <th>Data</th>
                    <th>Status</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @* Caso não haja chamados, mostra mensagem amigável *@
                @if (!Model.Any())
            {
                <tr>
                    <td colspan="6">
                        <em>Nenhum chamado encontrado.</em>
                    </td>
                </tr>
            }
            else
            {
                @* Lista os chamados *@
                foreach (var c in Model)
                {
                <tr>
                    <td>@c.Id</td>
                    <td>
                        @* Se for técnico, mostra nome e e-mail; caso contrário, mostra trecho da descrição *@
                        @if (isTecnico)
                            {
                        @($"{c.Nome ?? "-"}")  <br />
                        <small class="text-muted">@($"{c.Email ?? "-"}")</small>
                            }
                            else
                            {
                        @($"{ (c.Descricao != null ? string.Join(" ", c.Descricao.Split(' ').Take(6)) : "-") }")
                            }
                    </td>
                    <td>@(c.Urgencia ?? "-")</td>
                    <td>@(c.DataAbertura?.ToLocalTime().ToString("g") ?? "-")</td>
                    <td>@(c.Status ?? "-")</td>
                    <td>
                        <a class="btn btn-sm btn-info" href="@Url.Action("Details","Chamados", new { id = c.Id })">Detalhes</a>
                    </td>
                </tr>
                }
            }
            </tbody>
        </table>
    </div>
